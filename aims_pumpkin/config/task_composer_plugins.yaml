# Anchors
DoneTask: &done
  class: DoneTaskFactory
  config:
    conditional: false

ErrorTask: &error
  class: ErrorTaskFactory
  config:
    conditional: false
    trigger_abort: true

KinematicLimitsCheckTask: &limits_check
  class: KinematicLimitsCheckTaskFactory
  config:
    conditional: true
    inputs:
      program: output_program
      environment: environment
      profiles: profiles

# --------------------------------------------------------------------------
# Task composer configuration
# --------------------------------------------------------------------------
task_composer_plugins:
  search_libraries:
    - aims_pumpkin_plugins
  executors:
    default: TaskflowExecutor
    plugins:
      TaskflowExecutor:
        class: TaskflowTaskComposerExecutorFactory
        config:
          threads: 4

  tasks:
    plugins:
      # ===============================================================
      # Freespace Motion Planning Pipeline
      # ===============================================================
      FreespacePipeline:
        class: GraphTaskFactory
        config:
          inputs:
            program: input_program
          outputs:
            program: output_program

          nodes:
            DoneTask:
              class: DoneTaskFactory
              config:
                conditional: false

            ErrorTask:
              class: ErrorTaskFactory
              config:
                conditional: false
                trigger_abort: true

            OMPLMotionPlannerTask:
              class: OMPLMotionPlannerTaskFactory
              config:
                conditional: true
                inputs:
                  program: input_program
                  environment: environment
                  profiles: profiles
                outputs:
                  program: ompl_output
                format_result_as_input: false

            IterativeSplineParameterizationTask:
              class: IterativeSplineParameterizationTaskFactory
              config:
                conditional: true
                inputs:
                  program: ompl_output
                  environment: environment
                  profiles: profiles
                outputs:
                  program: output_program

            DiscreteContactCheckTask:
              class: DiscreteContactCheckTaskFactory
              config:
                conditional: true
                inputs:
                  program: ompl_output
                  environment: environment
                  profiles: profiles

            KinematicLimitsCheckTask: *limits_check

          edges:
            - source: OMPLMotionPlannerTask
              destinations: [ErrorTask, DiscreteContactCheckTask]
            - source: DiscreteContactCheckTask
              destinations: [ErrorTask, IterativeSplineParameterizationTask]
            - source: IterativeSplineParameterizationTask
              destinations: [ErrorTask, KinematicLimitsCheckTask]
            - source: KinematicLimitsCheckTask
              destinations: [ErrorTask, DoneTask]

          terminals: [ErrorTask, DoneTask]

      # ===============================================================
      # Cartesian Motion Planning Pipeline
      # ===============================================================
      CartesianPipeline:
        class: GraphTaskFactory
        config:
          inputs:
            program: input_program
          outputs:
            program: output_program

          nodes:
            DoneTask:
              class: DoneTaskFactory
              config:
                conditional: false

            ErrorTask:
              class: ErrorTaskFactory
              config:
                conditional: false
                trigger_abort: true

            TrajOptMotionPlannerTask:
              class: TrajOptMotionPlannerTaskFactory
              config:
                conditional: true
                inputs:
                  program: input_program
                  environment: environment
                  profiles: profiles
                outputs:
                  program: trajopt_output
                format_result_as_input: false

            IterativeSplineParameterizationTask:
              class: IterativeSplineParameterizationTaskFactory
              config:
                conditional: true
                inputs:
                  program: trajopt_output
                  environment: environment
                  profiles: profiles
                outputs:
                  program: output_program
            
            DiscreteContactCheckTask:
              class: DiscreteContactCheckTaskFactory
              config:
                conditional: true
                inputs:
                  program: ompl_output
                  environment: environment
                  profiles: profiles

            KinematicLimitsCheckTask: *limits_check

          edges:
            - source: TrajOptMotionPlannerTask
              destinations: [ErrorTask, DiscreteContactCheckTask]
            - source: DiscreteContactCheckTask
              destinations: [ErrorTask, IterativeSplineParameterizationTask]
            - source: IterativeSplineParameterizationTask
              destinations: [ErrorTask, KinematicLimitsCheckTask]
            - source: KinematicLimitsCheckTask
              destinations: [ErrorTask, DoneTask]

          terminals: [ErrorTask, DoneTask]
